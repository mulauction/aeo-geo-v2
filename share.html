<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AEO/GEO v2 - Share</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="./styles.css">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Pretendard', sans-serif;
      margin: 0;
      padding: 24px;
      background: #f5f5f5;
    }
    .app {
      max-width: 960px;
      margin: 0 auto;
      background: #fff;
      padding: 32px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .home-link {
      margin-bottom: 24px;
      display: inline-block;
    }
    
    /* 리포트 헤더 */
    .report-header {
      border-bottom: 3px solid #333;
      padding-bottom: 20px;
      margin-bottom: 32px;
    }
    .report-header h1 {
      margin: 0 0 16px 0;
      font-size: 28px;
      font-weight: 700;
      color: #1a1a1a;
    }
    .report-header-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      font-size: 14px;
      color: #666;
    }
    .report-header-meta-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .report-header-meta-label {
      font-weight: 600;
      color: #333;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .report-header-meta-value {
      color: #666;
    }
    .report-header-trust {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e0e0e0;
      font-size: 11px;
      color: #888;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .report-header-trust-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .report-header-trust-label {
      font-weight: 600;
      color: #666;
    }
    
    /* KPI 그리드 (3단 카드형) */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 32px;
    }
    .kpi-card {
      padding: 20px;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      border-left: 4px solid #4a90e2;
    }
    .kpi-card-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .kpi-card-value {
      font-size: 24px;
      font-weight: 700;
      color: #1a1a1a;
    }
    .kpi-card-grade {
      font-size: 14px;
      color: #666;
      margin-top: 4px;
    }
    .kpi-card.muted {
      border-left-color: #ccc;
    }
    .kpi-card.muted .kpi-card-value {
      color: #999;
    }
    
    /* 콘텐츠 섹션 */
    #shareContent {
      margin-top: 0;
    }
    .content-section {
      margin-bottom: 32px;
    }
    .content-section h2 {
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 16px 0;
      color: #1a1a1a;
      padding-bottom: 8px;
      border-bottom: 2px solid #e0e0e0;
    }
    .content-section h3 {
      font-size: 18px;
      font-weight: 600;
      margin: 24px 0 12px 0;
      color: #333;
    }
    .content-section h4 {
      font-size: 16px;
      font-weight: 600;
      margin: 20px 0 12px 0;
      color: #333;
    }
    .content-section p {
      line-height: 1.8;
      color: #444;
      margin: 0 0 12px 0;
    }
    .content-section ul {
      margin: 0 0 20px 0;
      padding-left: 24px;
    }
    .content-section li {
      margin-bottom: 8px;
      line-height: 1.8;
      color: #444;
    }
    .score-display {
      font-size: 32px;
      font-weight: 700;
      color: #1a1a1a;
      margin: 16px 0;
    }
    
    /* Evidence 안내 박스 */
    .notice-card {
      margin-top: 32px;
      padding: 20px;
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 8px;
      border-left: 4px solid #999;
    }
    .notice-card h4 {
      margin: 0 0 12px 0;
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }
    .notice-card p {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: #666;
      line-height: 1.6;
    }
    .notice-card-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-top: 16px;
    }
    .notice-card-column h5 {
      margin: 0 0 8px 0;
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }
    .notice-card-column ul {
      margin: 0;
      padding-left: 20px;
      font-size: 13px;
      color: #666;
    }
    .notice-card-column li {
      margin-bottom: 6px;
      line-height: 1.5;
    }
    
    /* Action 카드 그리드 */
    .action-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 16px;
    }
    .action-card {
      padding: 16px;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      border-top: 3px solid #4a90e2;
    }
    .action-card.quick {
      border-top-color: #28a745;
    }
    .action-card.next {
      border-top-color: #ffc107;
    }
    .action-card.advanced {
      border-top-color: #dc3545;
    }
    .action-card-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin: 0 0 12px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .action-card-list {
      margin: 0;
      padding-left: 20px;
      font-size: 13px;
      color: #444;
    }
    .action-card-list li {
      margin-bottom: 6px;
      line-height: 1.6;
    }
    
    /* 리포트 푸터 */
    .report-footer {
      margin-top: 48px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
      font-size: 10px;
      color: #999;
      line-height: 1.6;
      text-align: center;
    }
    .report-footer p {
      margin: 0 0 4px 0;
    }
    
    #btnExportPDF {
      margin-top: 24px;
      padding: 12px 24px;
      font-size: 16px;
    }
    
    /* ✅ [Phase 5-8] PDF 인쇄 스타일 (A4 기준, 리포트 품질) */
    @media print {
      @page {
        size: A4;
        margin: 20mm 20mm 20mm 20mm;
      }
      
      body {
        padding: 0;
        background: #fff;
        font-size: 11pt;
        line-height: 1.6;
        color: #000;
      }
      
      .app {
        max-width: 100%;
        margin: 0;
        padding: 0;
        box-shadow: none;
        border-radius: 0;
      }
      
      /* 버튼/입력/네비 숨김 */
      .home-link,
      #btnExportPDF,
      button,
      input,
      select,
      .btn {
        display: none !important;
      }
      
      /* 리포트 헤더 */
      .report-header {
        border-bottom: 2px solid #000;
        padding-bottom: 16px;
        margin-bottom: 24px;
        page-break-after: avoid;
      }
      .report-header h1 {
        font-size: 24pt;
        margin: 0 0 12px 0;
      }
      .report-header-meta {
        font-size: 10pt;
        gap: 12px;
      }
      .report-header-meta-label {
        font-size: 9pt;
      }
      .report-header-trust {
        font-size: 8pt;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #ccc;
      }
      
      /* KPI 그리드 */
      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-bottom: 24px;
        page-break-inside: avoid;
      }
      .kpi-card {
        padding: 16px;
        background: #f8f8f8;
        border: 1px solid #ddd;
        border-left: 3px solid #333;
        page-break-inside: avoid;
      }
      .kpi-card-label {
        font-size: 9pt;
      }
      .kpi-card-value {
        font-size: 18pt;
      }
      .kpi-card-grade {
        font-size: 11pt;
      }
      
      /* 콘텐츠 섹션 */
      .content-section {
        margin-bottom: 24px;
        page-break-inside: avoid;
      }
      .content-section h2 {
        font-size: 16pt;
        margin: 0 0 12px 0;
        padding-bottom: 6px;
        border-bottom: 1px solid #000;
        page-break-after: avoid;
      }
      .content-section h3 {
        font-size: 14pt;
        margin: 20px 0 10px 0;
        page-break-after: avoid;
      }
      .content-section h4 {
        font-size: 12pt;
        margin: 16px 0 8px 0;
        page-break-after: avoid;
      }
      .content-section p {
        font-size: 11pt;
        line-height: 1.6;
        margin: 0 0 10px 0;
        orphans: 3;
        widows: 3;
      }
      .content-section ul {
        margin: 0 0 16px 0;
        padding-left: 20px;
        page-break-inside: avoid;
      }
      .content-section li {
        margin-bottom: 6px;
        line-height: 1.6;
        font-size: 11pt;
      }
      .score-display {
        font-size: 24pt;
        margin: 12px 0;
      }
      
      /* Evidence 안내 박스 */
      .notice-card {
        margin-top: 24px;
        padding: 16px;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-left: 3px solid #666;
        page-break-inside: avoid;
      }
      .notice-card h4 {
        font-size: 12pt;
        margin: 0 0 10px 0;
      }
      .notice-card p {
        font-size: 10pt;
        margin: 0 0 6px 0;
      }
      .notice-card-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-top: 12px;
      }
      .notice-card-column h5 {
        font-size: 10pt;
      }
      .notice-card-column ul {
        font-size: 9pt;
        padding-left: 16px;
      }
      .notice-card-column li {
        font-size: 9pt;
        margin-bottom: 4px;
      }
      
      /* Action 카드 그리드 */
      .action-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-top: 12px;
      }
      .action-card {
        padding: 12px;
        background: #f8f8f8;
        border: 1px solid #ddd;
        border-top: 2px solid #333;
        page-break-inside: avoid;
      }
      .action-card-title {
        font-size: 10pt;
        margin: 0 0 8px 0;
      }
      .action-card-list {
        font-size: 9pt;
        padding-left: 16px;
      }
      .action-card-list li {
        font-size: 9pt;
        margin-bottom: 4px;
      }
      
      /* 리포트 푸터 */
      .report-footer {
        margin-top: 32px;
        padding-top: 16px;
        border-top: 1px solid #ccc;
        font-size: 7pt;
        page-break-inside: avoid;
      }
      
      /* 페이지 나누기 제어 */
      .report-header,
      .kpi-grid,
      .content-section,
      .notice-card,
      .action-grid,
      .report-footer {
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <a href="./home.html" class="home-link">Home</a>
    
    <div id="reportHeader" class="report-header">
      <!-- 리포트 헤더는 JavaScript로 동적 렌더링 -->
    </div>
    
    <div id="shareContent">
      <!-- 리포트 콘텐츠는 JavaScript로 동적 렌더링 -->
    </div>
    
    <div id="reportFooter" class="report-footer">
      <!-- 리포트 푸터는 JavaScript로 동적 렌더링 -->
    </div>
    
    <button id="btnExportPDF" class="btn btn-primary">PDF로 내보내기</button>
  </div>

  <script type="module">
    import { buildReportPayload } from './core/report.js';
    import { renderKpi } from './core/view.js';
    import { isLoggedIn, gateOrWarn } from './core/gate.js';
    
    // ✅ [Phase 4-2 Gate] share.html 진입 즉시 로그인 체크
    // 리포트 렌더/복원 로직을 절대 실행하지 않도록 가장 먼저 체크
    if (!isLoggedIn()) {
      // document.title 변경
      document.title = "Login required";
      
      // ✅ [Phase 4-2 Gate] Print 차단: window.print 오버라이드
      const originalPrint = window.print;
      window.print = () => {
        alert("로그인 후 리포트를 인쇄할 수 있습니다.");
        return false;
      };
      
      // ✅ [Phase 4-2 Gate] Print 차단: Ctrl/Cmd+P 키보드 이벤트 차단
      window.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'p') {
          e.preventDefault();
          e.stopPropagation();
          alert("로그인 후 리포트를 인쇄할 수 있습니다.");
          return false;
        }
      }, true);
      
      // ✅ [Phase 4-2 Gate] Print 차단: beforeprint 이벤트 차단
      window.addEventListener('beforeprint', (e) => {
        e.preventDefault();
        alert("로그인 후 리포트를 인쇄할 수 있습니다.");
        return false;
      }, true);
      
      // document.body를 로그인 안내 화면으로 교체
      document.body.innerHTML = `
        <div class="app" style="max-width: 960px; margin: 0 auto; padding: 24px;">
          <h1 style="margin: 0 0 24px 0;">로그인 필요</h1>
          <div style="padding: 24px; background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border);">
            <p style="margin: 0 0 16px 0; color: var(--muted);">리포트를 보려면 로그인이 필요합니다.</p>
            <a href="./home.html" class="btn btn-primary" style="display: inline-block; text-decoration: none;">홈으로 이동</a>
          </div>
        </div>
      `;
      
      // 리포트 렌더/복원 로직을 절대 실행하지 않도록 즉시 중단
      // window.__lastV2 / localStorage 기반 복원도 실행하지 않게 보장
      // (함수 정의 이후 실행되는 코드가 없으므로 자연스럽게 중단됨)
    } else {
      // 로그인 상태일 때만 리포트 렌더링 로직 실행
      
      function esc(v) {
        return String(v)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;");
      }
      
      function renderShareContent() {
        const payload = buildReportPayload();
        const scores = payload.analysis?.scores || {};
        const brandingScore = scores.branding;
        const contentStructureV2Score = scores.contentStructureV2;
        const urlStructureV1Score = scores.urlStructureV1;
        
        // ✅ [Phase 5-8] 리포트 헤더 렌더링
        let analysisTarget = '분석 대상 없음';
        if (payload.input) {
          // HTML 태그 제거 및 텍스트만 추출
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = payload.input;
          let textContent = tempDiv.textContent || tempDiv.innerText || '';
          textContent = textContent.trim();
          if (textContent.length > 80) {
            analysisTarget = textContent.substring(0, 80) + '...';
          } else {
            analysisTarget = textContent || 'HTML 콘텐츠';
          }
        }
        const analysisDate = payload.generatedAt ? new Date(payload.generatedAt).toLocaleString('ko-KR', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }) : new Date().toLocaleString('ko-KR');
        
        const reportHeader = `
          <h1>AEO/GEO 분석 리포트</h1>
          <div class="report-header-meta">
            <div class="report-header-meta-item">
              <span class="report-header-meta-label">분석 대상</span>
              <span class="report-header-meta-value">${esc(analysisTarget)}</span>
            </div>
            <div class="report-header-meta-item">
              <span class="report-header-meta-label">분석 일시</span>
              <span class="report-header-meta-value">${esc(analysisDate)}</span>
            </div>
          </div>
          <div class="report-header-trust">
            <div class="report-header-trust-item">
              <span class="report-header-trust-label">Report v3</span>
            </div>
            <div class="report-header-trust-item">
              <span class="report-header-trust-label">생성 방식:</span>
              <span>자동 분석 엔진</span>
            </div>
            <div class="report-header-trust-item">
              <span class="report-header-trust-label">포함 범위:</span>
              <span>Share-only 리포트</span>
            </div>
          </div>
        `;
        
        // ✅ [Phase 5-8] KPI 그리드 (3단 카드형)
        const kpiCard = (label, value) => {
          if (value === null || value === undefined) {
            return `
              <div class="kpi-card muted">
                <div class="kpi-card-label">${esc(label)}</div>
                <div class="kpi-card-value">측정 필요</div>
              </div>
            `;
          }
          const score = value.score !== null && value.score !== undefined ? value.score : 'N/A';
          const grade = value.grade || 'N/A';
          return `
            <div class="kpi-card">
              <div class="kpi-card-label">${esc(label)}</div>
              <div class="kpi-card-value">${esc(score)}</div>
              <div class="kpi-card-grade">등급: ${esc(grade)}</div>
            </div>
          `;
        };
        
        const kpiGrid = `
          <div class="kpi-grid">
            ${kpiCard('엔티티 점수', brandingScore)}
            ${kpiCard('콘텐츠 구조 점수', contentStructureV2Score)}
            ${(() => {
              const card = kpiCard('URL 구조 점수', urlStructureV1Score);
              if (urlStructureV1Score && urlStructureV1Score.score !== null && urlStructureV1Score.score !== undefined) {
                return card.replace('</div>', ` <span style="font-size: 11px; color: #4a90e2;">· 연결됨</span></div>`);
              }
              return card;
            })()}
          </div>
        `;
        
        // ✅ [Phase 5-8] 콘텐츠 구조 점수 근거 섹션
        let contentStructureEvidenceSection = '';
        if (contentStructureV2Score && contentStructureV2Score.evidence && Array.isArray(contentStructureV2Score.evidence) && contentStructureV2Score.evidence.length > 0) {
          contentStructureEvidenceSection = `
            <div class="content-section">
              <h3>콘텐츠 구조 점수 근거</h3>
              <ul>
                ${contentStructureV2Score.evidence.map(e => `<li>${esc(e)}</li>`).join("")}
              </ul>
            </div>
          `;
        }
        
        // ✅ [Phase 5-8 v3] 결과 섹션
        const result = payload.result;
        let resultSection = '';
        if (result) {
          // 액션을 3개 카드로 분류 (Quick/Next/Advanced)
          const actions = result.actions || [];
          const quickActions = actions.slice(0, Math.ceil(actions.length / 3));
          const nextActions = actions.slice(Math.ceil(actions.length / 3), Math.ceil(actions.length * 2 / 3));
          const advancedActions = actions.slice(Math.ceil(actions.length * 2 / 3));
          
          const actionCards = `
            <div class="action-grid">
              <div class="action-card quick">
                <div class="action-card-title">Quick Actions</div>
                <ul class="action-card-list">
                  ${quickActions.length > 0 ? quickActions.map(a => `<li>${esc(a)}</li>`).join("") : '<li>없음</li>'}
                </ul>
              </div>
              <div class="action-card next">
                <div class="action-card-title">Next Steps</div>
                <ul class="action-card-list">
                  ${nextActions.length > 0 ? nextActions.map(a => `<li>${esc(a)}</li>`).join("") : '<li>없음</li>'}
                </ul>
              </div>
              <div class="action-card advanced">
                <div class="action-card-title">Advanced</div>
                <ul class="action-card-list">
                  ${advancedActions.length > 0 ? advancedActions.map(a => `<li>${esc(a)}</li>`).join("") : '<li>없음</li>'}
                </ul>
              </div>
            </div>
          `;
          
          resultSection = `
            <div class="content-section">
              <h2>분석 결과</h2>
              <div class="score-display">${esc(result.score)}점 / ${esc(result.grade)}</div>
              <p>${esc(result.summary)}</p>
              <h3>근거</h3>
              <ul>
                ${result.evidence.map(e => `<li>${esc(e)}</li>`).join("")}
              </ul>
              <h3>액션</h3>
              ${actionCards}
            </div>
          `;
        }
        
        // ✅ [Phase 5-8 v3] Evidence 안내 박스 (2단 리스트)
        const loggedIn = isLoggedIn();
        
        // 현재 포함되는 근거 목록
        const currentEvidence = [];
        if (contentStructureV2Score && contentStructureV2Score.evidence && Array.isArray(contentStructureV2Score.evidence) && contentStructureV2Score.evidence.length > 0) {
          currentEvidence.push('콘텐츠 구조 점수 근거');
        }
        if (urlStructureV1Score && urlStructureV1Score.score !== null && urlStructureV1Score.score !== undefined) {
          currentEvidence.push('URL 구조 점수 상태');
        }
        if (currentEvidence.length === 0) {
          currentEvidence.push('기본 분석 결과');
        }
        
        // 곧 제공될 기능 목록
        const upcomingFeatures = [
          '히스토리 기반 Evidence',
          '엔진별 상세 근거',
          '링크 공유 기능'
        ];
        
        const evidenceSection = `
          <div class="notice-card">
            <h4>Evidence</h4>
            ${loggedIn ? `
              <div class="notice-card-grid">
                <div class="notice-card-column">
                  <h5>현재 포함</h5>
                  <ul>
                    ${currentEvidence.map(e => `<li>${esc(e)}</li>`).join("")}
                  </ul>
                </div>
                <div class="notice-card-column">
                  <h5>곧 제공</h5>
                  <ul>
                    ${upcomingFeatures.map(f => `<li>${esc(f)}</li>`).join("")}
                  </ul>
                </div>
              </div>
            ` : `
              <p>Evidence 기능을 사용하려면 로그인이 필요합니다.</p>
            `}
          </div>
        `;
        
        // ✅ [Phase 5-8 v3] 리포트 푸터
        const reportFooter = `
          <p>본 리포트는 자동 분석 결과를 기반으로 생성되었으며, 참고용으로만 사용하시기 바랍니다.</p>
          <p>Report v3 · AEO/GEO 분석 도구 · ${new Date().getFullYear()}</p>
        `;
        
        document.getElementById('reportHeader').innerHTML = reportHeader;
        document.getElementById('shareContent').innerHTML = kpiGrid + contentStructureEvidenceSection + resultSection + evidenceSection;
        document.getElementById('reportFooter').innerHTML = reportFooter;
      }
      
      // ✅ [Phase 4-2 Gate] PDF 버튼 게이트 적용
      const btnExportPDF = document.getElementById('btnExportPDF');
      if (btnExportPDF) {
        btnExportPDF.addEventListener('click', () => {
          if (!gateOrWarn("PDF 내보내기")) return;
          
          // ✅ [Phase 3-2D] PDF 생성 (print 스타일 적용)
          window.print();
        });
      }
      
      // 로그인 상태일 때만 리포트 렌더링 실행
      renderShareContent();
    }
  </script>
</body>
</html>

