<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AEO/GEO v2 - Share</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="./styles.css">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Pretendard', sans-serif;
      margin: 0;
      padding: 24px;
      background: #f5f5f5;
    }
    .app {
      max-width: 960px;
      margin: 0 auto;
      background: #fff;
      padding: 32px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .home-link {
      margin-bottom: 24px;
      display: inline-block;
    }
    
    /* 리포트 헤더 */
    .report-header {
      border-bottom: 3px solid #333;
      padding-bottom: 20px;
      margin-bottom: 32px;
    }
    .report-header h1 {
      margin: 0 0 12px 0;
      font-size: 28px;
      font-weight: 700;
      color: #1a1a1a;
    }
    .report-header-summary {
      margin: 0 0 16px 0;
      font-size: 14px;
      line-height: 1.7;
      color: #555;
      max-width: 800px;
    }
    .report-header-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      font-size: 14px;
      color: #666;
    }
    .report-header-meta-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .report-header-meta-label {
      font-weight: 600;
      color: #333;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .report-header-meta-value {
      color: #666;
    }
    .report-header-trust {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e0e0e0;
      font-size: 11px;
      color: #888;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .report-header-trust-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .report-header-trust-label {
      font-weight: 600;
      color: #666;
    }
    /* Share 링크 정책 안내 (MVP: same-browser only) */
    .share-policy {
      margin: 14px 0 18px;
      padding: 10px 12px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.02);
    }
    .share-policy__title {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 6px;
      color: #1a1a1a;
    }
    .share-policy__body {
      margin: 0;
    }
    .share-policy__body p {
      margin: 0 0 6px;
      font-size: 13px;
      line-height: 1.45;
      color: #444;
    }
    .share-policy__body p:last-child {
      margin-bottom: 0;
    }
    .share-policy__sub {
      margin-top: 2px;
      opacity: 0.72;
      font-size: 12px;
    }
    /* ✅ [Phase 11-2] Share 상태 표시 영역 */
    #share-status {
      margin: 12px 0;
      padding: 8px 12px;
      font-size: 12px;
      color: #666;
      text-align: center;
      display: none;
    }
    #share-status.show {
      display: block;
    }
    #share-status.error {
      color: #dc3545;
    }
    /* ✅ [Phase 10-2] 리포트 없음 경고 박스 */
    .report-warning-box {
      margin: 24px 0;
      padding: 20px;
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      border-left: 4px solid #ffc107;
    }
    .report-warning-box h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }
    .report-warning-box p {
      margin: 0 0 16px 0;
      font-size: 14px;
      color: #666;
      line-height: 1.6;
    }
    .report-warning-box .btn-home {
      display: inline-block;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      color: #fff;
      background: #0066cc;
      border: none;
      border-radius: 4px;
      text-decoration: none;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .report-warning-box .btn-home:hover {
      background: #0052a3;
    }
    /* ✅ [Phase 10-1] 고정 리포트 UI */
    .report-header-fixed {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .report-header-fixed-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 600;
      color: #555;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
    }
    .report-header-fixed-id {
      font-size: 11px;
      color: #666;
      font-family: monospace;
    }
    .report-header-fixed-copy-btn {
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 500;
      color: #0066cc;
      background: #fff;
      border: 1px solid #0066cc;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.2s ease;
    }
    .report-header-fixed-copy-btn:hover {
      background: #f0f7ff;
    }
    .report-header-fixed-copy-btn:active {
      background: #e0efff;
    }
    .report-header-fixed-toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 8px 16px;
      font-size: 12px;
      color: #fff;
      background: #28a745;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      pointer-events: none;
    }
    .report-header-fixed-toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    /* KPI Bar 그래프 (3종 시각화) */
    .kpi-bars {
      margin-bottom: 32px;
      position: relative;
    }
    /* ✅ [Phase 8-2A] 신뢰도 배지 */
    .reliability-container {
      position: absolute;
      top: 0;
      right: 0;
      text-align: right;
    }
    .reliability-badge {
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 500;
      color: #333;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      white-space: nowrap;
      display: inline-block;
    }
    /* ✅ [Phase 8-2B] 신뢰도 배지 컨테이너 (배지 + 자세히 버튼) */
    .reliability-badge-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    /* ✅ [Phase 8-2B] 자세히 버튼 */
    .reliability-details-btn {
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 500;
      color: #666;
      background: transparent;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
      white-space: nowrap;
    }
    .reliability-details-btn:hover {
      background: #f0f0f0;
      color: #333;
    }
    /* ✅ [Phase 8-2B] 신뢰도 사유 상세 영역 */
    .reliability-details {
      margin-top: 8px;
      padding: 12px;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
    }
    /* ✅ [Phase 8-2B] 신뢰도 사유 리스트 */
    .reliability-reasons-list {
      margin: 0;
      padding-left: 20px;
      font-size: 12px;
      color: #555;
      line-height: 1.6;
    }
    .reliability-reasons-list li {
      margin-bottom: 6px;
    }
    .reliability-reasons-list li:last-child {
      margin-bottom: 0;
    }
    /* ✅ [Phase 8-2B] 신뢰도 Reason line */
    .reliability-reason {
      margin-top: 4px;
      font-size: 12px;
      color: #999;
      white-space: nowrap;
    }
    /* ✅ [Phase 8-2B] 측정 필요 CTA */
    .measurement-cta {
      margin-bottom: 24px;
      padding: 16px;
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 4px;
      font-size: 13px;
      line-height: 1.6;
    }
    .measurement-cta-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    .measurement-cta-link {
      color: #0066cc;
      text-decoration: none;
      font-weight: 500;
    }
    .measurement-cta-link:hover {
      text-decoration: underline;
    }
    .kpi-bar-item {
      margin-bottom: 24px;
    }
    .kpi-bar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .kpi-bar-label {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .kpi-bar-value {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
    }
    .kpi-bar-container {
      height: 32px;
      background: #f0f0f0;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    .kpi-bar-fill {
      height: 100%;
      background: #4a90e2;
      border-radius: 4px;
      transition: width 0.4s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
      color: #fff;
      font-size: 12px;
      font-weight: 600;
    }
    .kpi-bar-item.muted .kpi-bar-container {
      background: #f5f5f5;
    }
    .kpi-bar-item.muted .kpi-bar-fill {
      display: none;
    }
    .kpi-bar-item.muted::after {
      content: '측정 필요';
      display: block;
      margin-top: 8px;
      font-size: 13px;
      color: #999;
      font-style: italic;
    }
    
    /* 신뢰 문구 섹션 */
    .trust-statements {
      margin-bottom: 24px;
      padding: 20px;
      background: #f8f9fa;
      border-left: 4px solid #666;
      border-radius: 4px;
    }
    .trust-statements p {
      margin: 0 0 12px 0;
      font-size: 13px;
      line-height: 1.7;
      color: #555;
    }
    .trust-statements p:last-child {
      margin-bottom: 0;
    }
    
    /* 한국 시장 특화 문구 */
    .market-context {
      margin-bottom: 32px;
      padding: 16px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-size: 13px;
      line-height: 1.7;
      color: #666;
    }
    
    /* ✅ [Phase 8-1] 측정 기준 설명 레이어 */
    .score-criteria-toggle {
      margin-bottom: 16px;
    }
    .score-criteria-btn {
      background: none;
      border: none;
      padding: 0;
      font-size: 13px;
      color: #666;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: inherit;
    }
    .score-criteria-btn:hover {
      color: #333;
    }
    .score-criteria-btn .caret {
      display: inline-block;
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 5px solid #666;
      transition: transform 0.2s ease;
    }
    .score-criteria-btn.open .caret {
      transform: rotate(180deg);
    }
    .score-criteria-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .score-criteria-content.open {
      max-height: 200px;
    }
    .score-criteria-list {
      margin-top: 12px;
      padding: 16px;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-size: 13px;
      line-height: 1.8;
      color: #555;
    }
    .score-criteria-list p {
      margin: 0 0 8px 0;
    }
    .score-criteria-list p:last-child {
      margin-bottom: 0;
    }
    
    /* ✅ [Phase 8-1] Compare 안내 문구 */
    .compare-notice {
      margin-top: 24px;
      padding: 16px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-size: 13px;
      line-height: 1.7;
      color: #666;
    }
    
    /* 콘텐츠 섹션 */
    #shareContent {
      margin-top: 0;
    }
    .content-section {
      margin-bottom: 32px;
    }
    .content-section h2 {
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 16px 0;
      color: #1a1a1a;
      padding-bottom: 8px;
      border-bottom: 2px solid #e0e0e0;
    }
    .content-section h3 {
      font-size: 18px;
      font-weight: 600;
      margin: 24px 0 12px 0;
      color: #333;
    }
    .content-section h4 {
      font-size: 16px;
      font-weight: 600;
      margin: 20px 0 12px 0;
      color: #333;
    }
    .content-section p {
      line-height: 1.8;
      color: #444;
      margin: 0 0 12px 0;
    }
    .content-section ul {
      margin: 0 0 20px 0;
      padding-left: 24px;
    }
    .content-section li {
      margin-bottom: 8px;
      line-height: 1.8;
      color: #444;
    }
    .score-display {
      font-size: 32px;
      font-weight: 700;
      color: #1a1a1a;
      margin: 16px 0;
    }
    
    /* Evidence 안내 박스 */
    .notice-card {
      margin-top: 32px;
      padding: 20px;
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 8px;
      border-left: 4px solid #999;
    }
    .notice-card h4 {
      margin: 0 0 12px 0;
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }
    .notice-card p {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: #666;
      line-height: 1.6;
    }
    .notice-card-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-top: 16px;
    }
    .notice-card-column h5 {
      margin: 0 0 8px 0;
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }
    .notice-card-column ul {
      margin: 0;
      padding-left: 20px;
      font-size: 13px;
      color: #666;
    }
    .notice-card-column li {
      margin-bottom: 6px;
      line-height: 1.5;
    }
    
    /* Action 카드 그리드 */
    .action-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 16px;
    }
    .action-card {
      padding: 16px;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      border-top: 3px solid #4a90e2;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .action-card:hover {
      background: #f0f0f0;
    }
    .action-card:focus {
      outline: 2px solid #4a90e2;
      outline-offset: 2px;
    }
    .action-card.quick {
      border-top-color: #28a745;
    }
    .action-card.next {
      border-top-color: #ffc107;
    }
    .action-card.advanced {
      border-top-color: #dc3545;
    }
    .action-card-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin: 0 0 12px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .action-card-list {
      margin: 0;
      padding-left: 20px;
      font-size: 13px;
      color: #444;
    }
    .action-card-list li {
      margin-bottom: 6px;
      line-height: 1.6;
    }
    
    /* ✅ [Phase 9-0] Next Actions 섹션 */
    .next-actions-section {
      margin-bottom: 32px;
      margin-top: 24px;
    }
    .next-actions-section h2 {
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 8px 0;
      color: #1a1a1a;
      padding-bottom: 8px;
      border-bottom: 2px solid #e0e0e0;
    }
    .next-actions-intro {
      font-size: 13px;
      color: #666;
      line-height: 1.6;
      margin: 0 0 16px 0;
    }
    .next-actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .next-action-card {
      padding: 16px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      border-left: 4px solid #4a90e2;
      position: relative;
    }
    .next-action-card.priority-high {
      border-left-color: #dc3545;
    }
    .next-action-card.priority-medium {
      border-left-color: #ffc107;
    }
    .next-action-card.priority-low {
      border-left-color: #28a745;
    }
    .next-action-badge {
      display: inline-block;
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 600;
      color: #fff;
      background: #666;
      border-radius: 4px;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .next-action-card.priority-high .next-action-badge {
      background: #dc3545;
    }
    .next-action-card.priority-medium .next-action-badge {
      background: #ffc107;
      color: #333;
    }
    .next-action-card.priority-low .next-action-badge {
      background: #28a745;
    }
    .next-action-title {
      font-size: 15px;
      font-weight: 600;
      color: #333;
      margin: 0 0 8px 0;
      line-height: 1.4;
    }
    .next-action-description {
      font-size: 13px;
      color: #666;
      line-height: 1.5;
      margin: 0 0 12px 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .next-action-cta {
      margin-top: 8px;
    }
    .next-action-cta a {
      display: inline-block;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
      color: #0066cc;
      text-decoration: none;
      border: 1px solid #0066cc;
      border-radius: 4px;
      transition: background 0.2s ease;
    }
    .next-action-cta a:hover {
      background: #f0f7ff;
      text-decoration: none;
    }
    
    /* 리포트 푸터 */
    .report-footer {
      margin-top: 48px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
      font-size: 10px;
      color: #999;
      line-height: 1.6;
      text-align: center;
    }
    .report-footer p {
      margin: 0 0 4px 0;
    }
    
    #btnExportPDF {
      margin-top: 24px;
      padding: 12px 24px;
      font-size: 16px;
    }
    
    /* ✅ [Phase 5-8] PDF 인쇄 스타일 (A4 기준, 리포트 품질) */
    @media print {
      @page {
        size: A4;
        margin: 14mm;
      }
      
      body {
        padding: 0;
        background: #fff;
        font-size: 11pt;
        line-height: 1.6;
        color: #000;
      }
      
      .app {
        max-width: 100%;
        margin: 0;
        padding: 0;
        box-shadow: none;
        border-radius: 0;
      }
      
      /* ✅ [Phase 8-3A-2] 긴 텍스트/URL/evidence 줄바꿈 처리 */
      * {
        overflow-wrap: anywhere;
        word-break: break-word;
      }
      
      /* 긴 URL이나 텍스트가 있는 요소에 추가 처리 */
      .report-header-meta-value,
      .content-section p,
      .content-section li,
      .notice-card p,
      .action-card-list li,
      .reliability-reasons-list li {
        overflow-wrap: anywhere;
        word-break: break-word;
      }
      
      /* 버튼/입력/네비 숨김 */
      .home-link,
      #btnExportPDF,
      button,
      input,
      select,
      .btn,
      .reliability-details-btn {
        display: none !important;
      }
      /* 인쇄 시 신뢰도 사유는 항상 표시 */
      .reliability-details {
        display: block !important;
      }
      
      /* ✅ [Phase 8-3A-2] 리포트 헤더 - 페이지 분할 안정화 */
      .report-header {
        border-bottom: 2px solid #000;
        padding-bottom: 16px;
        margin-bottom: 24px;
        page-break-after: avoid;
        break-inside: avoid;
        page-break-inside: avoid;
      }
      .report-header h1 {
        font-size: 24pt;
        margin: 0 0 10px 0;
      }
      .report-header-summary {
        font-size: 10pt;
        line-height: 1.6;
        margin: 0 0 12px 0;
        color: #333;
        max-width: 100%;
        page-break-after: avoid;
      }
      .report-header-meta {
        font-size: 10pt;
        gap: 12px;
      }
      .report-header-meta-label {
        font-size: 9pt;
      }
      .report-header-trust {
        font-size: 8pt;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #ccc;
      }
      /* ✅ [Phase 10-3] 공유 링크 정책 안내 - 인쇄 스타일 */
      .share-policy {
        margin: 10px 0;
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #f8f8f8;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      .share-policy__title {
        font-size: 10pt;
        margin-bottom: 4px;
      }
      .share-policy__body p {
        font-size: 9pt;
        margin: 0 0 4px;
        line-height: 1.4;
      }
      .share-policy__sub {
        font-size: 8pt;
        margin-top: 2px;
      }
      /* ✅ [Phase 11-2] Share 상태 표시 영역 - 인쇄 스타일 */
      #share-status {
        display: none !important;
      }
      /* ✅ [Phase 10-2] 리포트 없음 경고 박스 - 인쇄 스타일 */
      .report-warning-box {
        margin: 20px 0;
        padding: 16px;
        background: #fffbf0;
        border: 1px solid #ddd;
        border-left: 3px solid #333;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      .report-warning-box h3 {
        font-size: 12pt;
        margin: 0 0 10px 0;
      }
      .report-warning-box p {
        font-size: 10pt;
        margin: 0 0 12px 0;
      }
      .report-warning-box .btn-home {
        padding: 6px 12px;
        font-size: 10pt;
        display: none;
      }
      /* ✅ [Phase 10-1] 고정 리포트 UI - 인쇄 스타일 */
      .report-header-fixed {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #ccc;
        font-size: 8pt;
      }
      .report-header-fixed-badge {
        padding: 3px 6px;
        font-size: 8pt;
        border: 1px solid #ccc;
      }
      .report-header-fixed-id {
        font-size: 8pt;
      }
      .report-header-fixed-copy-btn {
        display: none !important;
      }
      .report-header-fixed-toast {
        display: none !important;
      }
      
      /* ✅ [Phase 8-3A-2] KPI Bar 그래프 - 페이지 분할 안정화 */
      .kpi-bars {
        margin-bottom: 24px;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      
      /* ✅ [Phase 8-3A-2] 신뢰도 배지 슬롯 - 페이지 분할 안정화 */
      #reliability-badge-slot {
        page-break-inside: avoid;
        break-inside: avoid;
      }
      /* 신뢰도 배지 */
      .reliability-container {
        position: absolute;
        top: 0;
        right: 0;
        text-align: right;
      }
      .reliability-badge {
        padding: 4px 8px;
        font-size: 10pt;
        background: #f8f8f8;
        border: 1px solid #ddd;
        display: inline-block;
      }
      .reliability-badge-container {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .reliability-details {
        margin-top: 6px;
        padding: 10px;
        background: #f8f8f8;
        border: 1px solid #ddd;
        font-size: 9pt;
      }
      .reliability-reasons-list {
        margin: 0;
        padding-left: 18px;
        font-size: 9pt;
        color: #555;
        line-height: 1.5;
      }
      .reliability-reasons-list li {
        margin-bottom: 4px;
      }
      .reliability-reason {
        margin-top: 3px;
        font-size: 9pt;
        color: #888;
        white-space: nowrap;
      }
      /* ✅ [Phase 8-3A-2] 측정 필요 CTA - 페이지 분할 안정화 */
      .measurement-cta {
        margin-bottom: 20px;
        padding: 12px;
        background: #fffbf0;
        border: 1px solid #ddd;
        font-size: 10pt;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      .measurement-cta-title {
        font-size: 10pt;
        margin-bottom: 6px;
      }
      .measurement-cta-link {
        font-size: 10pt;
      }
      /* ✅ [Phase 8-3A-2] KPI Bar 항목 - 페이지 분할 안정화 */
      .kpi-bar-item {
        margin-bottom: 16px;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      .kpi-bar-label {
        font-size: 10pt;
      }
      .kpi-bar-value {
        font-size: 11pt;
      }
      .kpi-bar-container {
        height: 24px;
      }
      .kpi-bar-fill {
        font-size: 9pt;
        padding-right: 6px;
      }
      .kpi-bar-item.muted::after {
        font-size: 9pt;
        margin-top: 6px;
      }
      
      /* ✅ [Phase 8-3A-2] 신뢰 문구 섹션 - 페이지 분할 안정화 */
      .trust-statements {
        margin-bottom: 20px;
        padding: 16px;
        background: #f8f8f8;
        border-left: 3px solid #333;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      .trust-statements p {
        font-size: 9pt;
        margin: 0 0 8px 0;
      }
      
      /* ✅ [Phase 8-3A-2] 한국 시장 특화 문구 - 페이지 분할 안정화 */
      .market-context {
        margin-bottom: 24px;
        padding: 12px;
        border: 1px solid #ddd;
        font-size: 9pt;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      
      /* ✅ [Phase 8-3A-2] 측정 기준 설명 레이어 - 페이지 분할 안정화 */
      .score-criteria-toggle {
        margin-bottom: 12px;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      
      .score-criteria-list {
        page-break-inside: avoid;
        break-inside: avoid;
      }
      .score-criteria-btn {
        font-size: 9pt;
      }
      .score-criteria-content {
        max-height: none !important;
      }
      .score-criteria-content.open {
        max-height: none !important;
      }
      .score-criteria-list {
        margin-top: 8px;
        padding: 12px;
        background: #f8f8f8;
        border: 1px solid #ddd;
        font-size: 9pt;
      }
      .score-criteria-list p {
        margin: 0 0 6px 0;
      }
      
      /* ✅ [Phase 8-3A-2] Compare 안내 문구 - 페이지 분할 안정화 */
      .compare-notice {
        margin-top: 16px;
        padding: 12px;
        border: 1px solid #ddd;
        font-size: 9pt;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      
      /* ✅ [Phase 8-3A-2] 콘텐츠 섹션 - 페이지 분할 안정화 */
      .content-section {
        margin-bottom: 24px;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      .content-section h2 {
        font-size: 16pt;
        margin: 0 0 12px 0;
        padding-bottom: 6px;
        border-bottom: 1px solid #000;
        page-break-after: avoid;
      }
      .content-section h3 {
        font-size: 14pt;
        margin: 20px 0 10px 0;
        page-break-after: avoid;
      }
      .content-section h4 {
        font-size: 12pt;
        margin: 16px 0 8px 0;
        page-break-after: avoid;
      }
      .content-section p {
        font-size: 11pt;
        line-height: 1.6;
        margin: 0 0 10px 0;
        orphans: 3;
        widows: 3;
      }
      .content-section ul {
        margin: 0 0 16px 0;
        padding-left: 20px;
        page-break-inside: avoid;
      }
      .content-section li {
        margin-bottom: 6px;
        line-height: 1.6;
        font-size: 11pt;
      }
      .score-display {
        font-size: 24pt;
        margin: 12px 0;
      }
      
      /* ✅ [Phase 8-3A-2] Evidence 안내 박스 - 페이지 분할 안정화 */
      .notice-card {
        margin-top: 24px;
        padding: 16px;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-left: 3px solid #666;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      
      .notice-card-grid {
        page-break-inside: avoid;
        break-inside: avoid;
      }
      .notice-card h4 {
        font-size: 12pt;
        margin: 0 0 10px 0;
      }
      .notice-card p {
        font-size: 10pt;
        margin: 0 0 6px 0;
      }
      .notice-card-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-top: 12px;
      }
      .notice-card-column h5 {
        font-size: 10pt;
      }
      .notice-card-column ul {
        font-size: 9pt;
        padding-left: 16px;
      }
      .notice-card-column li {
        font-size: 9pt;
        margin-bottom: 4px;
      }
      
      /* ✅ [Phase 8-3A-2] Action 카드 그리드 - 페이지 분할 안정화 */
      .action-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-top: 12px;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      .action-card {
        padding: 12px;
        background: #f8f8f8;
        border: 1px solid #ddd;
        border-top: 2px solid #333;
        page-break-inside: avoid;
        break-inside: avoid;
        cursor: default;
      }
      .action-card:hover {
        background: #f8f8f8;
      }
      .action-card-title {
        font-size: 10pt;
        margin: 0 0 8px 0;
      }
      .action-card-list {
        font-size: 9pt;
        padding-left: 16px;
      }
      .action-card-list li {
        font-size: 9pt;
        margin-bottom: 4px;
      }
      
      /* ✅ [Phase 9-0] Next Actions 섹션 - 인쇄 스타일 */
      .next-actions-section {
        margin-bottom: 20px;
        margin-top: 20px;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      .next-actions-section h2 {
        font-size: 16pt;
        margin: 0 0 6px 0;
        padding-bottom: 6px;
        border-bottom: 1px solid #000;
        page-break-after: avoid;
      }
      .next-actions-intro {
        font-size: 9pt;
        margin: 0 0 12px 0;
        page-break-after: avoid;
      }
      .next-actions-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-top: 12px;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      .next-action-card {
        padding: 10px;
        background: #fff;
        border: 1px solid #ddd;
        border-left: 3px solid #333;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      .next-action-badge {
        padding: 2px 6px;
        font-size: 7pt;
        margin-bottom: 4px;
      }
      .next-action-title {
        font-size: 10pt;
        margin: 0 0 4px 0;
      }
      .next-action-description {
        font-size: 8pt;
        margin: 0 0 6px 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
      }
      .next-action-cta {
        margin-top: 4px;
      }
      .next-action-cta a {
        padding: 3px 6px;
        font-size: 8pt;
        border: 1px solid #333;
      }
      
      /* ✅ [Phase 8-3A-2] 리포트 푸터 - 페이지 분할 안정화 */
      .report-footer {
        margin-top: 32px;
        padding-top: 16px;
        border-top: 1px solid #ccc;
        font-size: 7pt;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      
      /* ✅ [Phase 8-3A-2] 신뢰도 상세 영역 - 페이지 분할 안정화 */
      .reliability-details {
        page-break-inside: avoid;
        break-inside: avoid;
      }
      
      /* 페이지 나누기 제어 */
      .report-header,
      .kpi-bars,
      .next-actions-section,
      .score-criteria-toggle,
      .trust-statements,
      .market-context,
      .content-section,
      .notice-card,
      .compare-notice,
      .action-grid,
      .report-footer {
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <a href="./home.html" class="home-link">Home</a>
    
    <div id="reportHeader" class="report-header">
      <!-- 리포트 헤더는 JavaScript로 동적 렌더링 -->
    </div>
    
    <div id="shareContent">
      <!-- 리포트 콘텐츠는 JavaScript로 동적 렌더링 -->
    </div>
    
    <div id="reportFooter" class="report-footer">
      <!-- 리포트 푸터는 JavaScript로 동적 렌더링 -->
    </div>
    
    <button id="btnExportPDF" class="btn btn-primary">PDF로 내보내기</button>
  </div>

  <script type="module">
    import { buildReportPayload } from './core/report.js';
    import { renderKpi } from './core/view.js';
    import { isLoggedIn, gateOrWarn } from './core/gate.js';
    import { computeReliabilityV2, computeReliability } from './core/reliability.js';
    import { renderReliabilityBlock, renderReliabilityBadge } from './core/shareReliabilityUI.js';
    
    // === [Phase 10-0] Share reportId 고정 로직 ===
    const params = new URLSearchParams(location.search);
    let r = params.get('r');

    if (!r) {
      r = localStorage.getItem('__currentReportId') || '';

      if (!r) {
        try {
          const v2 = JSON.parse(localStorage.getItem('__lastV2') || 'null');

          // ⚠️ 새 ID 생성 금지
          // 이미 저장된 값 중 고유값으로 fallback
          r = String(
            v2?.reportId ||
            v2?.meta?.reportId ||
            v2?.meta?.id ||
            v2?.id ||
            v2?.generatedAt || ''
          );
        } catch (_) {}
      }

      if (r) {
        localStorage.setItem('__currentReportId', r);
        history.replaceState(
          null,
          '',
          `${location.pathname}?r=${encodeURIComponent(r)}`
        );
      }
    }
    
    /**
     * ✅ [Phase 11-2] Share 상태 표시 함수
     * @param {string} text - 표시할 텍스트 (빈 문자열이면 숨김)
     */
    function setShareStatus(text) {
      const statusEl = document.getElementById('share-status');
      if (!statusEl) return;
      
      if (!text || text.trim() === '') {
        statusEl.style.display = 'none';
        statusEl.className = '';
        statusEl.textContent = '';
      } else {
        statusEl.style.display = 'block';
        statusEl.textContent = text;
        statusEl.className = text.includes('404') || text.includes('찾을 수 없') ? 'error' : '';
      }
    }

    /**
     * ✅ [Phase 11-2] 서버 스냅샷 조회 (fallback)
     * @param {string} id - Snapshot ID
     * @returns {Promise<Object|null>} { notFound: true } 또는 { payload: reportModel }
     */
    async function fetchSnapshotWithFallback(id) {
      if (!id) return null;

      const endpoints = [
        `/api/share-snapshots/${encodeURIComponent(id)}`,
        `http://localhost:3001/api/share-snapshots/${encodeURIComponent(id)}`
      ];

      for (const endpoint of endpoints) {
          try {
            const response = await fetch(endpoint);
            if (response.ok) {
              const data = await response.json();
              // 서버 응답 스키마에 맞춰 조정: { version, createdAt, reportModel, meta }
              const v2 = data?.payload ?? data?.reportModel ?? data;
              return { payload: v2 };
            }
            // response.ok === false (404 포함) 이면 다음 엔드포인트 시도
            continue;
          } catch (err) {
            // 네트워크 오류 시 다음 엔드포인트 시도
            continue;
          }
      }
      // 모든 엔드포인트 실패 시 notFound 반환
      return { notFound: true };
    }
    
    /**
     * ✅ [Share 복원 로직] reportModel 복원 함수
     * 우선순위: (1) URL 파라미터 r → (2) window.__lastV2 / localStorage '__lastV2' → (3) localStorage 'aeo_state_v2'
     * @returns {Promise<Object|null>} reportModel 객체 또는 null
     */
    async function loadReportModel() {
      const urlParams = new URLSearchParams(window.location.search);
      const rParam = urlParams.get('r');
      
      // (1) URL 파라미터 r로 공유리포트 로드 시도
      if (rParam) {
        try {
          const decoded = decodeURIComponent(rParam);
          const parsed = JSON.parse(decoded);
          if (parsed && typeof parsed === 'object') {
            return parsed;
          }
        } catch (e) {
          // URL 파라미터 파싱 실패 시 다음 우선순위로 진행
        }
      }
      
      // (2) window.__lastV2 또는 localStorage '__lastV2'
      if (window.__lastV2) {
        return window.__lastV2;
      }
      
      try {
        const lastV2Str = localStorage.getItem('__lastV2');
        if (lastV2Str) {
          const parsed = JSON.parse(lastV2Str);
          if (parsed && typeof parsed === 'object') {
            return parsed;
          }
        }
      } catch (e) {
        // localStorage '__lastV2' 파싱 실패 시 다음 우선순위로 진행
      }
      
      // (3) localStorage 'aeo_state_v2' 기반 복원 (신규)
      try {
        const stStr = localStorage.getItem('aeo_state_v2');
        if (!stStr) {
          // ✅ [Phase 11-2] localStorage 복원 실패 시 서버 스냅샷 fallback
          if (rParam) {
            try {
              setShareStatus('서버에서 불러오는 중…');
              const data = await fetchSnapshotWithFallback(rParam);
              
              if (data?.notFound) {
                setShareStatus('스냅샷을 찾을 수 없습니다. (404)');
                return null;
              }
              
              if (data?.payload) {
                const v2 = data.payload;
                window.__lastV2 = v2;
                if (!localStorage.getItem('__currentReportId')) {
                  localStorage.setItem('__currentReportId', rParam);
                }
                setShareStatus('');
                return v2;
              }
            } catch (e) {
              console.warn('[share] snapshot fallback failed:', e);
              setShareStatus('서버에서 불러오지 못했습니다.');
            }
          }
          return null;
        }
        
        const st = JSON.parse(stStr);
        if (!st || typeof st !== 'object') {
          // ✅ [Phase 11-2] localStorage 복원 실패 시 서버 스냅샷 fallback
          if (rParam) {
            try {
              setShareStatus('서버에서 불러오는 중…');
              const data = await fetchSnapshotWithFallback(rParam);
              
              if (data?.notFound) {
                setShareStatus('스냅샷을 찾을 수 없습니다. (404)');
                return null;
              }
              
              if (data?.payload) {
                const v2 = data.payload;
                window.__lastV2 = v2;
                if (!localStorage.getItem('__currentReportId')) {
                  localStorage.setItem('__currentReportId', rParam);
                }
                setShareStatus('');
                return v2;
              }
            } catch (e) {
              console.warn('[share] snapshot fallback failed:', e);
              setShareStatus('서버에서 불러오지 못했습니다.');
            }
          }
          return null;
        }
        
        // reportModel 생성
        const reportModel = {
          inputs: {},
          analysis: {
            scores: st.analysis?.scores || {
              branding: null,
              contentStructureV2: null,
              urlStructureV1: null
            }
          },
          createdAt: null
        };
        
        // createdAt: st.updatedAt(밀리초) 있으면 ISO 문자열로 변환
        if (st.updatedAt && typeof st.updatedAt === 'number') {
          reportModel.createdAt = new Date(st.updatedAt).toISOString();
        }
        
        // inputs.brand/product: URLSearchParams에서 brand/product 있으면 사용, 없으면 st.input 문자열을 그대로 inputs.product에 넣기(brand는 빈값)
        const brandParam = urlParams.get('brand');
        const productParam = urlParams.get('product');
        
        if (brandParam) {
          reportModel.inputs.brand = brandParam;
        } else {
          reportModel.inputs.brand = '';
        }
        
        if (productParam) {
          reportModel.inputs.product = productParam;
        } else if (st.input && typeof st.input === 'string') {
          reportModel.inputs.product = st.input;
        } else {
          reportModel.inputs.product = '';
        }
        
        // 누락된 필드 안전하게 기본값 처리
        reportModel.result = st.result || null;
        reportModel.input = st.input || null;
        
        return reportModel;
      } catch (e) {
        // localStorage 'aeo_state_v2' 파싱 실패 시 서버 스냅샷 fallback
        if (rParam) {
          try {
            setShareStatus('서버에서 불러오는 중…');
            const data = await fetchSnapshotWithFallback(rParam);
            
            if (data?.notFound) {
              setShareStatus('스냅샷을 찾을 수 없습니다. (404)');
              return null;
            }
            
            if (data?.payload) {
              const v2 = data.payload;
              window.__lastV2 = v2;
              if (!localStorage.getItem('__currentReportId')) {
                localStorage.setItem('__currentReportId', rParam);
              }
              setShareStatus('');
              return v2;
            }
          } catch (err) {
            console.warn('[share] snapshot fallback failed:', err);
            setShareStatus('서버에서 불러오지 못했습니다.');
          }
        }
        return null;
      }
    }
    
    /**
     * ✅ [Share 복원 로직] reportModel을 기반으로 reportPayload 생성
     * @param {Object|null} reportModel - 복원된 reportModel 또는 null
     * @returns {Object} reportPayload 객체
     */
    function buildReportPayloadFromModel(reportModel) {
      if (!reportModel) {
        // reportModel이 없으면 기존 방식 사용
        return buildReportPayload();
      }
      
      // reportModel에서 reportPayload 생성
      const reportPayload = {
        input: reportModel.input || reportModel.inputs?.product || null,
        result: reportModel.result || null,
        analysis: {
          scores: reportModel.analysis?.scores || {
            branding: null,
            contentStructureV2: null,
            urlStructureV1: null
          }
        },
        generatedAt: reportModel.createdAt ? new Date(reportModel.createdAt).getTime() : Date.now()
      };
      
      return reportPayload;
    }
    
    // ✅ [Phase 4-2 Gate] share.html 진입 즉시 로그인 체크
    // 리포트 렌더/복원 로직을 절대 실행하지 않도록 가장 먼저 체크
    if (!isLoggedIn()) {
      // document.title 변경
      document.title = "Login required";
      
      // ✅ [Phase 4-2 Gate] Print 차단: window.print 오버라이드
      const originalPrint = window.print;
      window.print = () => {
        alert("로그인 후 리포트를 인쇄할 수 있습니다.");
        return false;
      };
      
      // ✅ [Phase 4-2 Gate] Print 차단: Ctrl/Cmd+P 키보드 이벤트 차단
      window.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'p') {
          e.preventDefault();
          e.stopPropagation();
          alert("로그인 후 리포트를 인쇄할 수 있습니다.");
          return false;
        }
      }, true);
      
      // ✅ [Phase 4-2 Gate] Print 차단: beforeprint 이벤트 차단
      window.addEventListener('beforeprint', (e) => {
        e.preventDefault();
        alert("로그인 후 리포트를 인쇄할 수 있습니다.");
        return false;
      }, true);
      
      // document.body를 로그인 안내 화면으로 교체
      document.body.innerHTML = `
        <div class="app" style="max-width: 960px; margin: 0 auto; padding: 24px;">
          <h1 style="margin: 0 0 24px 0;">로그인 필요</h1>
          <div style="padding: 24px; background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border);">
            <p style="margin: 0 0 16px 0; color: var(--muted);">리포트를 보려면 로그인이 필요합니다.</p>
            <a href="./home.html" class="btn btn-primary" style="display: inline-block; text-decoration: none;">홈으로 이동</a>
          </div>
        </div>
      `;
      
      // 리포트 렌더/복원 로직을 절대 실행하지 않도록 즉시 중단
      // window.__lastV2 / localStorage 기반 복원도 실행하지 않게 보장
      // (함수 정의 이후 실행되는 코드가 없으므로 자연스럽게 중단됨)
    } else {
      // 로그인 상태일 때만 리포트 렌더링 로직 실행
      
      function esc(v) {
        return String(v)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;");
      }
      
      async function renderShareContent() {
        // ✅ [Share 복원 로직] reportModel 복원 후 payload 생성
        // 기존 localStorage 복원 우선 (회귀 금지)
        const reportModel = await loadReportModel();
        
        // ✅ [Phase 10-2] 리포트를 그릴 수 없을 때 경고 표시
        if (!reportModel) {
          const params = new URLSearchParams(location.search);
          const r = params.get('r') || localStorage.getItem('__currentReportId');
          
          if (!r && !localStorage.getItem('__lastV2')) {
            const warningBox = `
              <div class="report-warning-box">
                <h3>리포트를 불러올 수 없습니다</h3>
                <p>공유 링크가 만료되었거나, 다른 브라우저/시크릿 모드에서 접근하셨습니다.<br>새로운 리포트를 생성하려면 Analyze 화면으로 이동해주세요.</p>
                <a href="./home.html" class="btn-home">Home으로</a>
              </div>
            `;
            document.getElementById('shareContent').innerHTML = warningBox;
            
            // ✅ [Phase 10-2] 리포트 없음 시 PDF 버튼 숨김/비활성화
            const btnExportPDF = document.getElementById('btnExportPDF');
            if (btnExportPDF) {
              btnExportPDF.style.display = 'none';
            }
            
            return;
          }
        }
        
        const payload = buildReportPayloadFromModel(reportModel);
        const scores = payload.analysis?.scores || {};
        const brandingScore = scores.branding;
        const contentStructureV2Score = scores.contentStructureV2;
        const urlStructureV1Score = scores.urlStructureV1;
        
        // ✅ [Phase 5-8] 리포트 헤더 렌더링
        let analysisTarget = '분석 대상 없음';
        if (payload.input) {
          // HTML 태그 제거 및 텍스트만 추출
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = payload.input;
          let textContent = tempDiv.textContent || tempDiv.innerText || '';
          textContent = textContent.trim();
          if (textContent.length > 80) {
            analysisTarget = textContent.substring(0, 80) + '...';
          } else {
            analysisTarget = textContent || 'HTML 콘텐츠';
          }
        }
        const analysisDate = payload.generatedAt ? new Date(payload.generatedAt).toLocaleString('ko-KR', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }) : new Date().toLocaleString('ko-KR');
        
        const reportHeader = `
          <h1>AEO/GEO 분석 리포트</h1>
          <div id="share-status"></div>
          <div class="report-header-summary">
            이 리포트는 AI 검색·추천 환경에서 해당 브랜드/콘텐츠가 얼마나 인식 가능한지, 구조적 기준으로 분석한 결과입니다. 점수는 '현재 상태'를 의미하며, 아래 액션은 개선 우선순위를 안내합니다.
          </div>
          <section class="share-policy" role="note" aria-label="공유 링크 안내">
            <div class="share-policy__title">공유 링크 안내</div>
            <div class="share-policy__body">
              <p>이 공유 링크는 현재 브라우저(동일 기기)에서만 리포트를 다시 열 수 있습니다.</p>
              <p>다른 기기·다른 브라우저·시크릿 모드에서는 리포트를 불러올 수 없습니다.</p>
              <p class="share-policy__sub">현재 버전(MVP)은 서버 저장 없이 로컬 분석 결과로만 표시됩니다.</p>
            </div>
          </section>
          <div class="report-header-meta">
            <div class="report-header-meta-item">
              <span class="report-header-meta-label">분석 대상</span>
              <span class="report-header-meta-value">${esc(analysisTarget)}</span>
            </div>
            <div class="report-header-meta-item">
              <span class="report-header-meta-label">분석 일시</span>
              <span class="report-header-meta-value">${esc(analysisDate)}</span>
            </div>
          </div>
          <div class="report-header-trust">
            <div class="report-header-trust-item">
              <span class="report-header-trust-label">Report v3</span>
            </div>
            <div class="report-header-trust-item">
              <span class="report-header-trust-label">생성 방식:</span>
              <span>자동 분석 엔진</span>
            </div>
            <div class="report-header-trust-item">
              <span class="report-header-trust-label">포함 범위:</span>
              <span>Share-only 리포트</span>
            </div>
          </div>
          ${(() => {
            const urlParams = new URLSearchParams(location.search);
            let currentR = urlParams.get('r');
            if (!currentR) {
              currentR = localStorage.getItem('__currentReportId') || '';
            }
            if (currentR) {
              const maskedId = currentR.length > 6 
                ? '…' + currentR.slice(-6) 
                : currentR;
              const shareUrl = location.origin + location.pathname + '?r=' + encodeURIComponent(currentR);
              return `
                <div class="report-header-fixed">
                  <span class="report-header-fixed-badge">재열람 링크 고정됨</span>
                  <span class="report-header-fixed-id">Report ID: ${esc(maskedId)}</span>
                  <button class="report-header-fixed-copy-btn" type="button" data-share-url="${esc(shareUrl)}">재열람 링크 복사</button>
                </div>
              `;
            }
            return '';
          })()}
        `;
        
        // ✅ [Phase 8-0] KPI Bar 그래프 (3종 시각화)
        const kpiBar = (label, value) => {
          if (value === null || value === undefined || value.score === null || value.score === undefined) {
            return `
              <div class="kpi-bar-item muted">
                <div class="kpi-bar-header">
                  <span class="kpi-bar-label">${esc(label)}</span>
                </div>
                <div class="kpi-bar-container"></div>
              </div>
            `;
          }
          const score = value.score;
          const grade = value.grade || '';
          const percentage = Math.min(Math.max(score, 0), 100);
          return `
            <div class="kpi-bar-item">
              <div class="kpi-bar-header">
                <span class="kpi-bar-label">${esc(label)}</span>
                <span class="kpi-bar-value">${esc(score)}${grade ? ' / ' + esc(grade) : ''}</span>
              </div>
              <div class="kpi-bar-container">
                <div class="kpi-bar-fill" style="width: ${percentage}%">${esc(score)}</div>
              </div>
            </div>
          `;
        };
        
        // ✅ [Phase 8-3] 신뢰도 계산 및 UI 렌더링 (모듈화)
        const reliabilityResultV2 = computeReliabilityV2(reportModel || { analysis: { scores: {} } });
        
        // ✅ [Phase 8-3A-1] Reliability 결과 계산 (완성도 규칙 기반)
        const lastV2 = window.__lastV2 || null;
        const reliabilityResult = computeReliability(reportModel || { analysis: { scores: {} } }, lastV2);
        
        // ✅ [Phase 8-3A-1] 측정 필요 CTA 생성 (1줄 요약만)
        let measurementCta = '';
        // reasons.length > 0 이거나 label이 '측정 필요'인 경우에만 표시
        if ((reliabilityResult.reasons && reliabilityResult.reasons.length > 0) || reliabilityResult.label === '측정 필요') {
          measurementCta = `
            <div class="measurement-cta">
              <div class="measurement-cta-title">측정 필요 항목이 있습니다. 신뢰도 배지에서 이유를 확인하세요.</div>
            </div>
          `;
        }
        
        // ✅ [Phase 8-3] 신뢰도 블록 렌더링 (모듈화)
        const { html: reliabilityHtml, bind: bindReliability } = renderReliabilityBlock(reportModel || { analysis: { scores: {} } });
        
        const kpiBars = `
          <div class="kpi-bars">
            ${reliabilityHtml}
            ${kpiBar('Brand', brandingScore)}
            ${kpiBar('Content Structure', contentStructureV2Score)}
            ${kpiBar('URL Structure', urlStructureV1Score)}
          </div>
          <div id="reliability-badge-slot"></div>
        `;
        
        // ✅ [Phase 8-1] 측정 기준 설명 레이어
        const scoreCriteriaToggle = `
          <div class="score-criteria-toggle">
            <button class="score-criteria-btn" id="btnScoreCriteria" type="button">
              <span class="caret"></span>
              <span>측정 기준 보기</span>
            </button>
            <div class="score-criteria-content" id="scoreCriteriaContent">
              <div class="score-criteria-list">
                <p>Brand 점수는 브랜드/상품 엔티티 인식 여부와 명시성을 기준으로 평가합니다.</p>
                <p>Content Structure 점수는 제목 구조, 문단 분리, 핵심 정보 배치를 중심으로 평가합니다.</p>
                <p>URL Structure 점수는 주소 구조, 연결성, AI 탐색 가능성을 기준으로 평가합니다.</p>
              </div>
            </div>
          </div>
        `;
        
        // ✅ [Phase 8-0] 신뢰 문구 2줄
        const trustStatements = `
          <div class="trust-statements">
            <p>이 리포트는 AI 검색·추천 환경에서의 인식 가능성을 구조 중심으로 분석합니다.</p>
            <p>각 항목은 독립적으로 측정되며, '측정 필요' 항목은 점수에 반영되지 않습니다.</p>
          </div>
        `;
        
        // ✅ [Phase 8-0] 한국 시장 특화 문구 1줄
        const marketContext = `
          <div class="market-context">
            국내 쇼핑몰은 이미지 중심 구조로 인해 AI가 정보를 해석하기 어려운 경우가 많습니다.
          </div>
        `;
        
        // ✅ [Phase 9-1] Next Actions 섹션 생성 (요약 형태)
        const nextActions = [];
        
        // 1) reliability.reasons가 있으면: "측정 필요/근거 부족" 액션 생성
        if (reliabilityResult.reasons && Array.isArray(reliabilityResult.reasons) && reliabilityResult.reasons.length > 0) {
          const missingItems = [];
          if (reliabilityResult.reasons.some(r => r.includes('BRAND') && r.includes('미측정'))) {
            missingItems.push('BRAND');
          }
          if (reliabilityResult.reasons.some(r => r.includes('CONTENT') && r.includes('미측정'))) {
            missingItems.push('CONTENT');
          }
          if (reliabilityResult.reasons.some(r => r.includes('URL') && r.includes('미측정'))) {
            missingItems.push('URL');
          }
          
          if (missingItems.length > 0) {
            nextActions.push({
              priority: 'high',
              title: '누락된 항목 측정하기',
              description: `${missingItems.join(', ')} 항목을 측정하여 신뢰도를 높이세요.`,
              cta: null
            });
          }
        }
        
        // 2) contentStructureV2.evidence가 비면: 콘텐츠 구조 개선 액션 생성
        const hasContentEvidence = contentStructureV2Score && 
          contentStructureV2Score.evidence && 
          Array.isArray(contentStructureV2Score.evidence) && 
          contentStructureV2Score.evidence.length > 0;
        
        if (!hasContentEvidence) {
          nextActions.push({
            priority: 'medium',
            title: '콘텐츠 구조 근거 수집하기',
            description: 'Analyze 화면에서 콘텐츠를 분석하여 근거를 생성하세요.',
            cta: { text: 'Analyze로 이동', href: './analyze.html' }
          });
        }
        
        // 3) urlStructureV1이 없으면: URL 측정 액션 생성 (+ Analyze로 이동)
        const isUrlMeasured = urlStructureV1Score && 
          urlStructureV1Score.score !== null && 
          urlStructureV1Score.score !== undefined &&
          !isNaN(urlStructureV1Score.score) &&
          isFinite(urlStructureV1Score.score);
        
        if (!isUrlMeasured) {
          nextActions.push({
            priority: 'high',
            title: 'URL 구조 측정하기',
            description: 'Analyze 화면에서 URL 구조를 분석하여 점수를 생성하세요.',
            cta: { text: 'Analyze로 이동', href: './analyze.html' }
          });
        }
        
        // Next Actions 섹션 HTML 생성 (요약 형태)
        let nextActionsSection = '';
        if (nextActions.length > 0) {
          // 기본 3개 + 상황별 최대 2개 (총 5개 초과 금지)
          const actionsToShow = nextActions.slice(0, 5);
          
          nextActionsSection = `
            <div class="next-actions-section">
              <h2>다음 액션 요약</h2>
              <div class="next-actions-intro">점수를 높이기 위해 지금 가장 먼저 할 작업입니다.</div>
              <div class="next-actions-grid">
                ${actionsToShow.map(action => `
                  <div class="next-action-card priority-${action.priority}">
                    <span class="next-action-badge">${action.priority === 'high' ? '높음' : action.priority === 'medium' ? '중간' : '낮음'}</span>
                    <div class="next-action-title">${esc(action.title)}</div>
                    <div class="next-action-description">${esc(action.description)}</div>
                    ${action.cta ? `
                      <div class="next-action-cta">
                        <a href="${esc(action.cta.href)}">${esc(action.cta.text)}</a>
                      </div>
                    ` : ''}
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }
        
        // ✅ [Phase 5-8] 콘텐츠 구조 점수 근거 섹션
        let contentStructureEvidenceSection = '';
        if (contentStructureV2Score && contentStructureV2Score.evidence && Array.isArray(contentStructureV2Score.evidence) && contentStructureV2Score.evidence.length > 0) {
          contentStructureEvidenceSection = `
            <div class="content-section">
              <h3>콘텐츠 구조 점수 근거</h3>
              <ul>
                ${contentStructureV2Score.evidence.map(e => `<li>${esc(e)}</li>`).join("")}
              </ul>
            </div>
          `;
        }
        
        // ✅ [Phase 5-8 v3] 결과 섹션
        const result = payload.result;
        let resultSection = '';
        let actionCardsSection = '';
        if (result) {
          // 액션을 3개 카드로 분류 (Quick/Next/Advanced)
          const actions = result.actions || [];
          const quickActions = actions.slice(0, Math.ceil(actions.length / 3));
          const nextActions = actions.slice(Math.ceil(actions.length / 3), Math.ceil(actions.length * 2 / 3));
          const advancedActions = actions.slice(Math.ceil(actions.length * 2 / 3));
          
          const actionCards = `
            <div class="action-grid">
              <div class="action-card quick" role="button" tabindex="0" onclick="location.href='analyze.html#quick'" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();location.href='analyze.html#quick';}">
                <div class="action-card-title">Quick Actions</div>
                <ul class="action-card-list">
                  ${quickActions.length > 0 ? quickActions.map(a => `<li>${esc(a)}</li>`).join("") : '<li>없음</li>'}
                </ul>
              </div>
              <div class="action-card next" role="button" tabindex="0" onclick="location.href='analyze.html#next'" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();location.href='analyze.html#next';}">
                <div class="action-card-title">Next Steps</div>
                <ul class="action-card-list">
                  ${nextActions.length > 0 ? nextActions.map(a => `<li>${esc(a)}</li>`).join("") : '<li>없음</li>'}
                </ul>
              </div>
              <div class="action-card advanced" role="button" tabindex="0" onclick="location.href='analyze.html#advanced'" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();location.href='analyze.html#advanced';}">
                <div class="action-card-title">Advanced</div>
                <ul class="action-card-list">
                  ${advancedActions.length > 0 ? advancedActions.map(a => `<li>${esc(a)}</li>`).join("") : '<li>없음</li>'}
                </ul>
              </div>
            </div>
          `;
          
          // ✅ [Phase 9-1 Fix] 액션 카드 섹션을 KPI 바로 아래로 이동
          actionCardsSection = `
            <div class="content-section">
              <h3>액션</h3>
              ${actionCards}
            </div>
          `;
          
          resultSection = `
            <div class="content-section">
              <h2>분석 결과</h2>
              <div class="score-display">${esc(result.score)}점 / ${esc(result.grade)}</div>
              <p>${esc(result.summary)}</p>
              <h3>근거</h3>
              <ul>
                ${result.evidence.map(e => `<li>${esc(e)}</li>`).join("")}
              </ul>
            </div>
          `;
        }
        
        // ✅ [Phase 5-8 v3] Evidence 안내 박스 (2단 리스트)
        const loggedIn = isLoggedIn();
        
        // 현재 포함되는 근거 목록
        const currentEvidence = [];
        if (contentStructureV2Score && contentStructureV2Score.evidence && Array.isArray(contentStructureV2Score.evidence) && contentStructureV2Score.evidence.length > 0) {
          currentEvidence.push('콘텐츠 구조 점수 근거');
        }
        if (urlStructureV1Score && urlStructureV1Score.score !== null && urlStructureV1Score.score !== undefined) {
          currentEvidence.push('URL 구조 점수 상태');
        }
        if (currentEvidence.length === 0) {
          currentEvidence.push('기본 분석 결과');
        }
        
        // 곧 제공될 기능 목록
        const upcomingFeatures = [
          '히스토리 기반 Evidence',
          '엔진별 상세 근거',
          '링크 공유 기능'
        ];
        
        const evidenceSection = `
          <div class="notice-card">
            <h4>Evidence</h4>
            ${loggedIn ? `
              <div class="notice-card-grid">
                <div class="notice-card-column">
                  <h5>현재 포함</h5>
                  <ul>
                    ${currentEvidence.map(e => `<li>${esc(e)}</li>`).join("")}
                  </ul>
                </div>
                <div class="notice-card-column">
                  <h5>곧 제공</h5>
                  <ul>
                    ${upcomingFeatures.map(f => `<li>${esc(f)}</li>`).join("")}
                  </ul>
                </div>
              </div>
            ` : `
              <p>Evidence 기능을 사용하려면 로그인이 필요합니다.</p>
            `}
          </div>
          <div class="compare-notice">
            비교 결과의 상세 구조 변화는 Analyze 화면의 Compare 기능에서 확인할 수 있습니다.
          </div>
        `;
        
        // ✅ [Phase 5-8 v3] 리포트 푸터
        const reportFooter = `
          <p>본 리포트는 자동 분석 결과를 기반으로 생성되었으며, 참고용으로만 사용하시기 바랍니다.</p>
          <p>Report v3 · AEO/GEO 분석 도구 · ${new Date().getFullYear()}</p>
        `;
        
        document.getElementById('reportHeader').innerHTML = reportHeader;
        const shareContentEl = document.getElementById('shareContent');
        shareContentEl.innerHTML = measurementCta + kpiBars + actionCardsSection + nextActionsSection + scoreCriteriaToggle + trustStatements + marketContext + contentStructureEvidenceSection + resultSection + evidenceSection;
        document.getElementById('reportFooter').innerHTML = reportFooter;
        
        // ✅ [Phase 11-2A] 재열람 링크 복사 버튼 이벤트 바인딩 (서버 스냅샷 생성)
        const copyBtn = document.querySelector('.report-header-fixed-copy-btn');
        if (copyBtn) {
          copyBtn.addEventListener('click', async () => {
            const originalText = copyBtn.textContent;
            
            try {
              // a) v2Summary 확보 (기존 우선순위 함수 재사용)
              let reportModel = null;
              if (window.__lastV2) {
                reportModel = window.__lastV2;
              } else {
                const lastV2Str = localStorage.getItem('__lastV2');
                if (lastV2Str) {
                  try {
                    reportModel = JSON.parse(lastV2Str);
                  } catch (e) {
                    // 파싱 실패 시 null 유지
                  }
                }
              }
              
              if (!reportModel || typeof reportModel !== 'object') {
                // 기존 로컬 복사 fallback
                const params = new URLSearchParams(location.search);
                let r = params.get('r');
                if (!r) {
                  r = localStorage.getItem('__currentReportId') || '';
                }
                const shareUrl = r 
                  ? (location.origin + location.pathname + '?r=' + encodeURIComponent(r))
                  : (copyBtn.getAttribute('data-share-url') || location.href);
                
                try {
                  await navigator.clipboard.writeText(shareUrl);
                  copyBtn.textContent = '복사됨';
                  setTimeout(() => { copyBtn.textContent = originalText; }, 1000);
                } catch (err) {
                  const textarea = document.createElement('textarea');
                  textarea.value = shareUrl;
                  textarea.style.position = 'fixed';
                  textarea.style.left = '-9999px';
                  document.body.appendChild(textarea);
                  textarea.select();
                  document.execCommand('copy');
                  document.body.removeChild(textarea);
                  copyBtn.textContent = '복사됨';
                  setTimeout(() => { copyBtn.textContent = originalText; }, 1000);
                }
                return;
              }
              
              // b) v2Summary 확보 (__lastV2 우선순위)
              const v2Summary =
                window.__lastV2 ||
                (() => { try { return JSON.parse(localStorage.getItem('__lastV2') || 'null'); } catch { return null; } })();
              
              if (!v2Summary) throw new Error('v2Summary 없음: __lastV2가 필요합니다.');
              
              // c) 서버 저장 시작
              setShareStatus('서버에 저장 중…');
              
              // d) POST 요청 (개발 단계: 실제 서버 엔드포인트만 사용)
              const endpoints = [
                'http://localhost:3001/api/share-snapshots'
              ];
              
              let snapshotId = null;
              for (const endpoint of endpoints) {
                try {
                  const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reportModel: v2Summary })
                  });
                  
                  if (response.ok) {
                    const data = await response.json();
                    snapshotId = data.id;
                    break;
                  } else if (response.status !== 404) {
                    // 404가 아니면 다음 엔드포인트 시도
                    continue;
                  }
                } catch (err) {
                  // 네트워크 오류 시 다음 엔드포인트 시도
                  continue;
                }
              }
              
              if (!snapshotId) {
                throw new Error('서버 저장 실패');
              }
              
              // e) 성공: id를 사용해 링크 생성 및 복사
              localStorage.setItem('__currentReportId', snapshotId);
              const shareUrl = `${location.origin}${location.pathname}?r=${encodeURIComponent(snapshotId)}`;
              
              // 클립보드 복사 (기존 로직 재사용)
              try {
                await navigator.clipboard.writeText(shareUrl);
              } catch (err) {
                // fallback: 임시 textarea 사용
                const textarea = document.createElement('textarea');
                textarea.value = shareUrl;
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
              }
              
              // 버튼 텍스트 변경
              copyBtn.textContent = '복사됨';
              setTimeout(() => {
                copyBtn.textContent = originalText;
              }, 1000);
              
              setShareStatus('');
              
            } catch (e) {
              // f) 에러 처리
              console.warn('[share] snapshot save failed', e);
              setShareStatus('서버 저장 실패');
              
              // 기존 로컬 복사 fallback
              const params = new URLSearchParams(location.search);
              let r = params.get('r');
              if (!r) {
                r = localStorage.getItem('__currentReportId') || '';
              }
              const shareUrl = r 
                ? (location.origin + location.pathname + '?r=' + encodeURIComponent(r))
                : (copyBtn.getAttribute('data-share-url') || location.href);
              
              try {
                await navigator.clipboard.writeText(shareUrl);
                copyBtn.textContent = '복사됨';
                setTimeout(() => { copyBtn.textContent = originalText; }, 1000);
              } catch (err) {
                const textarea = document.createElement('textarea');
                textarea.value = shareUrl;
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                copyBtn.textContent = '복사됨';
                setTimeout(() => { copyBtn.textContent = originalText; }, 1000);
              }
            }
          });
        }
        
        // ✅ 신뢰도 배지 렌더링 (read-only)
        const reliabilityBadgeSlot = document.getElementById('reliability-badge-slot');
        if (reliabilityBadgeSlot) {
          // reliabilityResult는 이미 위에서 계산됨
          renderReliabilityBadge(reliabilityBadgeSlot, reliabilityResult);
        }
        
        // ✅ [Phase 8-3] 신뢰도 블록 이벤트 바인딩 (모듈화)
        const kpiBarsEl = shareContentEl.querySelector('.kpi-bars');
        if (kpiBarsEl) {
          bindReliability(kpiBarsEl);
        }
        
        // ✅ [Phase 8-1] 측정 기준 토글 기능
        const btnScoreCriteria = document.getElementById('btnScoreCriteria');
        const scoreCriteriaContent = document.getElementById('scoreCriteriaContent');
        if (btnScoreCriteria && scoreCriteriaContent) {
          btnScoreCriteria.addEventListener('click', () => {
            const isOpen = scoreCriteriaContent.classList.contains('open');
            if (isOpen) {
              scoreCriteriaContent.classList.remove('open');
              btnScoreCriteria.classList.remove('open');
            } else {
              scoreCriteriaContent.classList.add('open');
              btnScoreCriteria.classList.add('open');
            }
          });
        }
        
        // ✅ [Phase 10-2] 리포트 렌더링 성공 시 PDF 버튼 활성화/노출
        const btnExportPDF = document.getElementById('btnExportPDF');
        if (btnExportPDF) {
          btnExportPDF.style.display = '';
          btnExportPDF.disabled = false;
          btnExportPDF.removeAttribute('aria-disabled');
        }
      }
      
      // ✅ [Phase 4-2 Gate] PDF 버튼 게이트 적용
      const btnExportPDF = document.getElementById('btnExportPDF');
      if (btnExportPDF) {
        btnExportPDF.addEventListener('click', () => {
          if (!gateOrWarn("PDF 내보내기")) return;
          
          // ✅ [Phase 3-2D] PDF 생성 (print 스타일 적용)
          window.print();
        });
      }
      
      // 로그인 상태일 때만 리포트 렌더링 실행
      renderShareContent();
    }
  </script>
</body>
</html>

