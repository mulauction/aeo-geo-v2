<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AEO/GEO v2 - Generate</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="../styles.css">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Pretendard', sans-serif;
      margin: 0;
      padding: 24px;
    }
    .app {
      max-width: 960px;
      margin: 0 auto;
    }
    .home-link {
      margin-bottom: 24px;
      display: inline-block;
    }
    h1 {
      margin: 0 0 24px 0;
    }
    .input-group {
      margin-bottom: 16px;
    }
    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--muted);
    }
    input[type="text"] {
      width: 100%;
    }
    #btnGen {
      padding: 10px 20px;
    }
    #output {
      margin-top: 16px;
      width: 100%;
      min-height: 300px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      box-sizing: border-box;
      resize: vertical;
    }
    .faq {
      margin-top: 24px;
    }
    .faq h4 {
      margin: 0 0 16px 0;
      font-size: 18px;
    }
    .faq > div {
      margin-bottom: 16px;
    }
    .faq p {
      margin: 4px 0;
    }
    #modalOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1000;
    }
    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 24px;
      z-index: 1001;
      max-width: 400px;
      width: 90%;
    }
    .modal h3 {
      margin: 0 0 16px 0;
    }
    .modal p {
      margin: 0 0 16px 0;
    }
    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
  </style>
</head>
<body>
  <div class="app">
    <a href="../home.html" class="home-link">Home</a>
    
    <div id="header"></div>
    
    <h1>Generate - AI용 콘텐츠 생성</h1>
    <p style="margin: 0 0 24px 0; color: var(--muted); font-size: 14px;">
      Generate는 콘텐츠 생성만 수행합니다. 생성된 콘텐츠는 점수에 영향을 주지 않습니다.
    </p>
    
    <section class="input-group" data-section="url-structure" style="margin-bottom: 24px; padding: 16px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);">
      <h3 style="margin: 0 0 10px 0; font-size: 18px;">URL 구조 점수 (미리보기: 로컬 규칙)</h3>
      <p style="margin: 0 0 12px 0; font-size: 13px; color: var(--muted);">실제 접속 기반 측정은 Analyze에서 진행</p>

      <label style="display: block; font-size: 13px; margin-bottom: 6px; color: var(--muted);">분석할 URL</label>
      <input
        type="url"
        placeholder="https://example.com/page"
        data-input="target-url"
        class="input"
        style="width: 100%;"
      />

      <div style="height: 10px;"></div>

      <button
        type="button"
        class="btn btn-primary"
        data-action="run-url-structure"
      >
        URL 구조 점수 측정
      </button>

      <div style="height: 10px;"></div>

      <div
        data-output="url-structure-result"
        style="font-size: 13px; color: var(--muted);"
      >
        아직 점수 계산/저장 로직은 연결되지 않았습니다. (UI만 복구된 상태)
      </div>
    </section>
    
    <div class="input-group">
      <label for="product">제품명</label>
      <input type="text" id="product" class="input" />
    </div>
    
    <div class="input-group">
      <label for="brand">브랜드명</label>
      <input type="text" id="brand" class="input" />
    </div>
    
    <div class="input-group">
      <label for="usecase">사용 상황 한 줄</label>
      <input type="text" id="usecase" class="input" />
    </div>
    
    <button id="btnGen" class="btn btn-primary">HTML 생성</button>
    
    <textarea id="output" class="input" readonly></textarea>
    
    <!-- ✅ [Phase 15-2] 4종 고정 출력 섹션 -->
    <div style="margin-top: 32px; padding-top: 32px; border-top: 2px solid var(--border);">
      <h2 style="margin: 0 0 16px 0; font-size: 20px;">4종 생성 출력</h2>
      
      <!-- ✅ [Phase 15-2] "4종 출력이란?" 안내 카드 -->
      <div style="margin-bottom: 24px; padding: 16px; background: #f0f7ff; border: 1px solid #b3d9ff; border-radius: var(--radius);">
        <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600; color: #0066cc;">4종 출력이란?</h3>
        <div style="display: grid; gap: 8px; font-size: 14px; line-height: 1.6; color: #333;">
          <div><strong>AI 설명:</strong> 제품/브랜드/사용상황을 AI가 이해하기 쉽게 요약 (모델이 답변에 인용하기 좋게)</div>
          <div><strong>FAQ:</strong> 구매 전 질문을 구조화 (대화형 검색/AI 쇼핑 질의 대응)</div>
          <div><strong>비교:</strong> 경쟁상품 대비 강점 포인트를 정리 (추천/비교질의 대응)</div>
          <div><strong>요약:</strong> 페이지 최상단 3~5문장 요약 (인용/스니펫 대응)</div>
        </div>
      </div>
      
      <button id="btnGen4" class="btn btn-primary" style="margin-bottom: 24px;">4종 생성</button>
      
      <div style="display: grid; gap: 20px;">
        <!-- AI 설명 -->
        <div class="gen-output-section" data-section="ai-description">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3 style="margin: 0; font-size: 16px; font-weight: 600;">AI 설명</h3>
            <button class="btn-copy-output" data-copy-target="output-ai-description" style="padding: 4px 12px; font-size: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">복사</button>
          </div>
          <div id="output-ai-description" style="min-height: 100px; padding: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); font-size: 14px; line-height: 1.6; color: var(--text); white-space: pre-wrap;">생성된 내용이 여기에 표시됩니다.</div>
        </div>
        
        <!-- FAQ -->
        <div class="gen-output-section" data-section="faq">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3 style="margin: 0; font-size: 16px; font-weight: 600;">FAQ</h3>
            <button class="btn-copy-output" data-copy-target="output-faq" style="padding: 4px 12px; font-size: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">복사</button>
          </div>
          <div id="output-faq" style="min-height: 100px; padding: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); font-size: 14px; line-height: 1.6; color: var(--text); white-space: pre-wrap;">생성된 내용이 여기에 표시됩니다.</div>
        </div>
        
        <!-- 비교 -->
        <div class="gen-output-section" data-section="compare">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3 style="margin: 0; font-size: 16px; font-weight: 600;">비교</h3>
            <button class="btn-copy-output" data-copy-target="output-compare" style="padding: 4px 12px; font-size: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">복사</button>
          </div>
          <div id="output-compare" style="min-height: 100px; padding: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); font-size: 14px; line-height: 1.6; color: var(--text); white-space: pre-wrap;">생성된 내용이 여기에 표시됩니다.</div>
        </div>
        
        <!-- 요약 -->
        <div class="gen-output-section" data-section="summary">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3 style="margin: 0; font-size: 16px; font-weight: 600;">요약</h3>
            <button class="btn-copy-output" data-copy-target="output-summary" style="padding: 4px 12px; font-size: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">복사</button>
          </div>
          <div id="output-summary" style="min-height: 100px; padding: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); font-size: 14px; line-height: 1.6; color: var(--text); white-space: pre-wrap;">생성된 내용이 여기에 표시됩니다.</div>
        </div>
      </div>
      
      <!-- ✅ [Phase 15-2] "어디에 붙이나요?" 섹션 -->
      <div style="margin-top: 32px; padding: 16px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);">
        <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">어디에 붙이나요?</h3>
        <div style="font-size: 14px; line-height: 1.7; color: var(--text);">
          <div style="margin-bottom: 12px;">
            <strong>스마트스토어/쿠팡:</strong> 상세페이지 하단 '텍스트/HTML 영역' 또는 '상세 설명'에 삽입 권장
          </div>
          <div style="margin-bottom: 12px;">
            <strong>Webflow/자사몰:</strong> 제품 상세 하단에 HTML 블록으로 삽입
          </div>
          <div style="margin-bottom: 12px;">
            <strong>블로그:</strong> 본문 상단 요약 + 중간 FAQ
          </div>
          <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); font-size: 12px; color: var(--muted);">
            주의: 과장/없는 기능 금지, 실제 정보로 수정 후 사용
          </div>
        </div>
      </div>
      
      <!-- ✅ [Phase 15-2] "결과값이 매번 바뀌나요?" 섹션 -->
      <div style="margin-top: 16px; padding: 16px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);">
        <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">결과값이 매번 바뀌나요?</h3>
        <div style="font-size: 14px; line-height: 1.7; color: var(--text);">
          <p style="margin: 0 0 8px 0;">
            현재는 <strong>(테스트용/템플릿 기반)</strong>이라 입력이 같으면 거의 동일하게 나옵니다.
          </p>
          <p style="margin: 0; font-size: 12px; color: var(--muted);">
            향후 API 연결/리라이팅 모드에서 변동 가능합니다.
          </p>
        </div>
      </div>
    </div>
  </div>

  <div id="modalOverlay"></div>
  
  <div id="loginModal" class="modal">
    <h3>로그인 필요</h3>
    <p id="modalReason" style="display: none;"></p>
    <div class="modal-buttons">
      <button id="btnModalClose" class="btn-secondary">취소</button>
      <button id="btnModalLogin" class="btn-primary">로그인</button>
    </div>
  </div>

  <div id="creditModal" class="modal">
    <h3>크레딧 부족</h3>
    <p>필요 크레딧: <strong id="creditModalCost"></strong></p>
    <p id="creditModalReason" style="display: none;"></p>
    <div class="modal-buttons">
      <button id="btnCreditModalClose" class="btn-secondary">확인</button>
    </div>
  </div>

  <script type="module">
    import { bindActions } from './core/actions.js';
    import { renderHeader } from '../core/header.js';
    import { createLoginModal, createCreditModal } from '../core/modal.js';
    import { setModals, requireLogin, requireCredit } from '../core/gate.js';
    import { spendCredit } from '../core/credit.js';
    import { getState, setState } from '../core/state.js';
    import { calculateUrlPreviewScore } from './core/urlPreview.js';

    const LS_KEY_URL = '__urlStructureV1';

    const root = {
      product: document.getElementById("product"),
      brand: document.getElementById("brand"),
      usecase: document.getElementById("usecase"),
      btnGen: document.getElementById("btnGen"),
      output: document.getElementById("output"),
      btnGen4: document.getElementById("btnGen4"),
      outputAiDescription: document.getElementById("output-ai-description"),
      outputFaq: document.getElementById("output-faq"),
      outputCompare: document.getElementById("output-compare"),
      outputSummary: document.getElementById("output-summary"),
    };

    const headerEl = document.getElementById("header");
    if (headerEl) {
      renderHeader(headerEl);
    }

    const loginModal = createLoginModal();
    const creditModal = createCreditModal();
    setModals(loginModal, creditModal);
    window.loginModalInstance = loginModal;

    bindActions(root);

    // ✅ [Phase 15-2] 4종 생성 출력 관리
    const LS_KEY_GEN_V1 = '__genV1';
    
    /**
     * ✅ [Phase 15-2] 4종 출력 생성 함수 (더미 텍스트)
     * ⚠️ [PRODUCT_PRINCIPLES] analysis.scores를 읽거나 쓰지 않습니다.
     */
    function generate4Outputs() {
      const product = root.product.value.trim() || '제품명';
      const brand = root.brand.value.trim() || '브랜드명';
      const usecase = root.usecase.value.trim() || '일상에서';
      
      return {
        aiDescription: `${brand} ${product}는 ${usecase} 사용하는 사용자에게 최적화된 솔루션입니다.\n\nAI 검색 환경에서 이 제품은 구조화된 정보를 통해 빠르게 이해되고 추천될 수 있습니다. 핵심 기능과 주요 특징이 명확하게 제시되어 있어 AI가 정확하게 분류하고 매칭할 수 있습니다.`,
        faq: `Q: ${product}는 어떤 경우에 사용하나요?\nA: ${usecase} 필요할 때 ${brand} ${product}를 활용하시면 효과적입니다.\n\nQ: ${brand} ${product}의 주요 특징은 무엇인가요?\nA: 구조화된 정보 구성으로 빠른 이해와 활용이 가능합니다.\n\nQ: ${product} 사용 시 주의사항이 있나요?\nA: 기본 사용법을 숙지하시면 효과적으로 활용하실 수 있습니다.`,
        compare: `이전 버전과 비교하여 ${product}는 다음과 같은 개선사항을 제공합니다:\n\n• 구조화된 정보 구성으로 AI 인식도 향상\n• 핵심 기능과 특징의 명확한 제시\n• ${usecase} 사용자에게 최적화된 솔루션\n\n이러한 변경사항은 AI 검색 환경에서 더 나은 노출과 추천을 가능하게 합니다.`,
        summary: `${brand} ${product}는 ${usecase} 사용자에게 최적화된 솔루션으로, AI 검색 환경에서 효과적으로 노출될 수 있도록 구조화되었습니다. 핵심 기능과 특징이 명확하게 제시되어 있어 빠른 이해와 활용이 가능합니다.`
      };
    }
    
    /**
     * ✅ [Phase 15-2] 4종 출력을 localStorage에 저장
     */
    function saveGenOutputs(outputs) {
      try {
        localStorage.setItem(LS_KEY_GEN_V1, JSON.stringify({
          outputs,
          createdAt: Date.now()
        }));
      } catch (e) {
        console.warn('[Generate] 저장 실패:', e);
      }
    }
    
    /**
     * ✅ [Phase 15-2] localStorage에서 4종 출력 복원
     */
    function loadGenOutputs() {
      try {
        const stored = localStorage.getItem(LS_KEY_GEN_V1);
        if (stored) {
          const parsed = JSON.parse(stored);
          if (parsed && parsed.outputs) {
            return parsed.outputs;
          }
        }
      } catch (e) {
        console.warn('[Generate] 복원 실패:', e);
      }
      return null;
    }
    
    /**
     * ✅ [Phase 15-2] 4종 출력을 화면에 표시
     */
    function renderGenOutputs(outputs) {
      if (!outputs) return;
      
      if (root.outputAiDescription && outputs.aiDescription) {
        root.outputAiDescription.textContent = outputs.aiDescription;
      }
      if (root.outputFaq && outputs.faq) {
        root.outputFaq.textContent = outputs.faq;
      }
      if (root.outputCompare && outputs.compare) {
        root.outputCompare.textContent = outputs.compare;
      }
      if (root.outputSummary && outputs.summary) {
        root.outputSummary.textContent = outputs.summary;
      }
    }
    
    // ✅ [Phase 15-2] 4종 생성 버튼 이벤트 바인딩
    if (root.btnGen4) {
      root.btnGen4.addEventListener('click', () => {
        if (!requireLogin({ reason: "4종 생성 기능을 사용하려면 로그인이 필요합니다." })) {
          return;
        }

        if (!requireCredit(2, { reason: "4종 생성 기능을 사용하려면 2 크레딧이 필요합니다." })) {
          return;
        }

        spendCredit(2);
        
        // 4종 출력 생성
        const outputs = generate4Outputs();
        
        // 화면에 표시
        renderGenOutputs(outputs);
        
        // localStorage에 저장
        saveGenOutputs(outputs);
      });
    }
    
    // ✅ [Phase 15-2] 페이지 로드 시 복원
    const savedOutputs = loadGenOutputs();
    if (savedOutputs) {
      renderGenOutputs(savedOutputs);
    }
    
    /**
     * ✅ [Phase 15-2] 클립보드 복사 함수 (fallback 포함)
     * @param {string} text - 복사할 텍스트
     * @returns {Promise<boolean>} 성공 여부
     */
    async function copyToClipboard(text) {
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          return true;
        }
      } catch (e) {
        // clipboard API 실패 시 fallback 시도
      }
      
      // Fallback: textarea 생성 → select → execCommand
      try {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.left = '-999999px';
        textarea.style.top = '-999999px';
        document.body.appendChild(textarea);
        textarea.select();
        const success = document.execCommand('copy');
        document.body.removeChild(textarea);
        return success;
      } catch (e) {
        return false;
      }
    }
    
    /**
     * ✅ [Phase 15-2] 토스트 메시지 표시 함수
     * @param {string} message - 표시할 메시지
     */
    function showToast(message) {
      // 기존 토스트 제거
      const existingToast = document.getElementById('gen-toast');
      if (existingToast) {
        existingToast.remove();
      }
      
      const toast = document.createElement('div');
      toast.id = 'gen-toast';
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 16px;
        background: #4caf50;
        color: white;
        border-radius: 4px;
        font-size: 13px;
        z-index: 10000;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        animation: toastSlideIn 0.3s ease-out;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'toastSlideOut 0.3s ease-out';
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }, 1000);
    }
    
    // ✅ [Phase 15-2] 토스트 애니메이션 CSS 추가 (1회만)
    if (!document.getElementById('gen-toast-styles')) {
      const style = document.createElement('style');
      style.id = 'gen-toast-styles';
      style.textContent = `
        @keyframes toastSlideIn {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
        @keyframes toastSlideOut {
          from {
            transform: translateX(0);
            opacity: 1;
          }
          to {
            transform: translateX(100%);
            opacity: 0;
          }
        }
      `;
      document.head.appendChild(style);
    }
    
    // ✅ [Phase 15-2] 복사 버튼 이벤트 바인딩
    document.querySelectorAll('.btn-copy-output').forEach(btn => {
      btn.addEventListener('click', async () => {
        const targetId = btn.getAttribute('data-copy-target');
        if (!targetId) return;
        
        const targetEl = document.getElementById(targetId);
        if (!targetEl) return;
        
        const textToCopy = targetEl.textContent || '';
        if (!textToCopy || textToCopy.trim() === '' || textToCopy === '생성된 내용이 여기에 표시됩니다.') {
          showToast('복사할 내용이 없습니다');
          return;
        }
        
        const success = await copyToClipboard(textToCopy);
        if (success) {
          const originalText = btn.textContent;
          btn.textContent = '복사됨';
          btn.style.background = '#4caf50';
          btn.style.color = 'white';
          showToast('클립보드에 복사되었습니다');
          
          setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = '';
            btn.style.color = '';
          }, 1000);
        } else {
          showToast('복사 실패: 브라우저 권한을 확인해주세요');
        }
      });
    });

    // URL 구조 점수 측정 UI
    (() => {
      const btn = document.querySelector('[data-action="run-url-structure"]');
      const input = document.querySelector('[data-input="target-url"]');
      const out = document.querySelector('[data-output="url-structure-result"]');
      if (!btn || !input || !out) return;

      // 페이지 로드 시 localStorage에서 복원
      try {
        const stored = localStorage.getItem(LS_KEY_URL);
        if (stored) {
          const parsed = JSON.parse(stored);
          if (parsed && parsed.meta && parsed.meta.targetUrl) {
            input.value = parsed.meta.targetUrl;
            if (parsed.score !== undefined && parsed.grade) {
              const reasons = parsed.reasons || [];
              const reasonsText = reasons.length > 0 ? `\n${reasons.join('\n')}` : '';
              out.textContent = `점수: ${parsed.score}점 (${parsed.grade}) - 복원됨${reasonsText}`;
            }
          }
        }
      } catch (e) {
        // 조용히 무시
      }

      btn.addEventListener('click', () => {
        const url = (input.value || '').trim();
        if (!url) {
          out.textContent = 'URL을 입력해주세요.';
          return;
        }

        // ✅ [Generate] URL 구조 점수 계산 (로컬 규칙 미리보기)
        const previewResult = calculateUrlPreviewScore(url);
        
        if (!previewResult) {
          out.textContent = '올바른 URL 형식이 아닙니다.';
          return;
        }

        // 디버그 로그 1줄만
        console.info(`[URL Preview] ${url} → ${previewResult.score}점`);

        // 현재 state 가져오기
        const currentState = getState();
        
        // 결과 생성
        const urlStructureResult = {
          score: previewResult.score,
          grade: previewResult.grade,
          checks: {
            pathDepth: previewResult.score >= 80 ? "shallow" : previewResult.score >= 60 ? "moderate" : "deep",
            queryUsage: previewResult.score >= 60 ? "minimal" : "mixed",
            slugClarity: previewResult.score >= 60 ? "clear" : "weak"
          },
          reasons: previewResult.reasons,
          meta: {
            targetUrl: url,
            analyzedAt: Date.now(),
            version: "v1",
            preview: true // 미리보기 표시
          }
        };

        // localStorage에 저장
        try {
          localStorage.setItem(LS_KEY_URL, JSON.stringify(urlStructureResult));
        } catch (e) {
          // 저장 실패 시 조용히 무시
        }

        // 기존 result가 있으면 병합, 없으면 새로 생성 (기존 score는 유지)
        const existingResult = currentState.result || {};
        const updatedResult = {
          ...existingResult,
          urlStructureV1: urlStructureResult
        };

        // state 업데이트
        setState({
          result: updatedResult
        });

        // UI 업데이트
        const reasonsText = previewResult.reasons.length > 0 ? `\n${previewResult.reasons.join('\n')}` : '';
        out.textContent = `점수: ${previewResult.score}점 (${previewResult.grade}) - 측정 완료${reasonsText}`;
      });
    })();

    // 개발용 디버그 훅 (localhost에서만)
    if (location.hostname === 'localhost') {
      window.__debug = window.__debug || {};
      window.__debug.urlStructure = { LS_KEY_URL };
      window.__debug.dumpUrlScore = () => {
        try {
          return JSON.parse(localStorage.getItem(LS_KEY_URL) || 'null');
        } catch (e) {
          return null;
        }
      };
    }
  </script>
</body>
</html>

